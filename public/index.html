<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HTML5 Boilerplate</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <h1>Register</h1>
  <script src="scripts.js"></script>
  
  <form method="POST" action="/users/signup">
    <label for="name">Name:</label>
    <input type="text" id="name" name="name" required>

    <label for="email">Email:</label>
    <input type="email" id="email" name="email" required>


    <input type="hidden" id="visitorId" name="visitorId">
    <input type="hidden" id="influencer" name="influencer">
    <input type="hidden" id="source" name="source">
    <input type="hidden" id="campaign" name="campaign">

    <input type="submit" value="SEND">
  </form>

<script>
  // läs queryparameter
  const qs = new URLSearchParams(window.location.search);
  const influencer = qs.get('influencer');
  const source = qs.get("source");
  const campaign = qs.get("campaign");

  // fyll gömda fält i formuläret
  if (influencer) document.getElementById("influencer").value = influencer;
  if (source) document.getElementById("source").value = source;
  if (campaign) document.getElementById("campaign").value = campaign;

  // skapa en enkel visitorID i cookie
  function getCookie(name) {
    return document.cookie.split(";").find(r => r.startsWith(name+"="))?.split("=")[1];
  }

  function setCookie(name, value, days) {
    const d = new Date();
    d.setTime(d.getTime() + days*24*60*60*1000);
    document.cookie = name + "=" + value + ";expires=" + d.toUTCString() + ";path=/";
  }
  
  const visitorIdInput = document.getElementById("visitorId");
  let vid = getCookie("visitorId");
  if (!vid) {
    vid = Math.random().toString(36).substring(2,12);
    setCookie("visitorId", vid, 365);
  }

  // sicka spårnings data till backend
  if (influencer || source || campaign) {
    fetch("/clicks", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ influencer, source, campaign, visitorId: visitorIdInput.value })
    }).catch(()=>{});
  }
</script>
</body>

</html>
